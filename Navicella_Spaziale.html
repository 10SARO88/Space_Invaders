<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Invaders Clone - Boss Fight!</title>
    <style>
        /* --- CSS Aggiornato --- */
        body {
            margin: 0;
            overflow: auto;
            height: 100vh;
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 20px;
            padding-bottom: 20px;
            box-sizing: border-box;
            cursor: none;
            touch-action: none;
        }

        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        #pre-game-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px;
            background-color: #111;
            border: 2px solid #0f0;
            border-radius: 10px;
            text-align: center;
            z-index: 110;
            flex-shrink: 0;
            max-width: 90%;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        #pre-game-screen h1 {
            margin-bottom: 20px;
            color: #ff0;
            font-size: 1.5rem;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.7);
        }

        #pre-game-screen label {
            margin-bottom: 10px;
            font-size: 1rem;
            color: #0f0;
        }

        #pre-game-screen select, #pre-game-screen button {
            font-family: inherit;
            font-size: 1rem;
            padding: 10px 15px;
            margin-top: 5px;
            background-color: #222;
            color: #fff;
            border: 1px solid #fff;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #pre-game-screen select {
            min-width: 150px;
            background-color: #333;
            text-align: center;
        }

        #pre-game-screen button {
            margin-top: 20px;
            transition: all 0.2s;
            border-color: #0f0;
            color: #0f0;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #pre-game-screen button:hover {
            background-color: #0f0;
            color: #000;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 255, 0, 0.7);
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 600px;
            margin: auto;
            border: 2px solid #333;
            background-color: #000;
            display: none;
            overflow: hidden;
            flex-shrink: 0;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.3);
            image-rendering: pixelated;
        }

        body.game-active #game-container { display: block; }
        body.game-active #pre-game-screen { display: none; }

        #sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #000000 0%, #0a0a2a 100%);
        }

        .star {
            position: absolute;
            background-color: #fff;
            border-radius: 50%;
            z-index: 0;
        }

        @keyframes starTwinkle {
           from { opacity: var(--start-opacity, 0.2); }
           to { opacity: var(--end-opacity, 0.8); }
        }

        .alien {
            position: absolute;
            font-size: 1.5rem;
            user-select: none;
            will-change: left, top, opacity;
            pointer-events: none;
            z-index: 1;
            transition: opacity 0.1s linear;
            text-shadow: 0 0 5px currentColor;
        }

        .alien-type-0 { color: #f55; animation: pulse 1s infinite alternate; }
        .alien-type-1 { color: #f55; animation: pulse 1.2s infinite alternate; }
        .alien-type-2 { color: #5f5; animation: pulse 0.8s infinite alternate; }
        .alien-type-3 { color: #5f5; animation: pulse 1.1s infinite alternate; }
        .alien-type-4 { color: #55f; animation: pulse 0.9s infinite alternate; }

        @keyframes pulse {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        #player-ship {
            position: absolute;
            bottom: 20px;
            width: 40px;
            height: auto;
            user-select: none;
            will-change: transform, opacity;
            z-index: 10;
            transition: opacity 0.2s linear, transform 0.1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 0 5px #0ff);
        }

        #player-ship img {
            display: block;
            width: 100%;
            height: auto;
            image-rendering: pixelated;
        }

        #player-ship.hit {
            opacity: 0.3 !important;
            animation: hitFlash 0.3s 3;
        }

        @keyframes hitFlash {
            0%, 100% { filter: drop-shadow(0 0 5px #0ff); }
            50% { filter: drop-shadow(0 0 15px #f00); }
        }

        #boss-ship {
            position: absolute;
            top: -100px;
            width: 100px;
            height: auto;
            z-index: 9;
            user-select: none;
            will-change: transform, opacity;
            transition: opacity 0.1s linear, transform 0.1s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #boss-ship img {
            display: block;
            width: 100%;
            height: auto;
            filter: drop-shadow(0 0 5px #f00) drop-shadow(0 0 10px #f00);
            image-rendering: pixelated;
        }

        #boss-ship.hit-visual {
            opacity: 0.5;
            animation: bossHitFlash 0.1s 3;
        }

        @keyframes bossHitFlash {
            0%, 100% { filter: drop-shadow(0 0 5px #f00) drop-shadow(0 0 10px #f00); }
            50% { filter: drop-shadow(0 0 15px #fff) drop-shadow(0 0 30px #ff0); }
        }

        .bullet, .enemy-bullet, .boss-bullet {
            position: absolute;
            z-index: 5;
            pointer-events: none;
            will-change: top;
            border-radius: 50%;
        }

        .bullet {
            width: 4px;
            height: 10px;
            background-color: #ff0;
            box-shadow: 0 0 5px #ff0, 0 0 10px #ff0;
            animation: bulletGlow 0.5s infinite alternate;
        }

        .enemy-bullet {
            width: 4px;
            height: 10px;
            background-color: #f0f;
            box-shadow: 0 0 5px #f0f, 0 0 10px #f0f;
            animation: bulletGlow 0.4s infinite alternate;
        }

        .boss-bullet {
            width: 6px;
            height: 12px;
            background-color: #f00;
            box-shadow: 0 0 6px #f00, 0 0 12px #f00;
            animation: bossBulletGlow 0.3s infinite alternate;
        }

        @keyframes bulletGlow {
            from { box-shadow: 0 0 5px currentcolor, 0 0 10px currentcolor; }
            to { box-shadow: 0 0 10px currentcolor, 0 0 20px currentcolor; }
        }

        @keyframes bossBulletGlow {
            from { box-shadow: 0 0 6px #f00, 0 0 12px #f00; }
            to { box-shadow: 0 0 12px #f00, 0 0 24px #f00; }
        }

        .explosion {
            position: absolute;
            font-size: 1.8rem;
            color: #ffa500;
            z-index: 20;
            pointer-events: none;
            animation: explosionFade 0.3s linear forwards;
            transform: translate(-50%, -50%);
            text-shadow: 0 0 10px #f80;
        }

        @keyframes explosionFade {
            0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
        }

        .particle {
            position: absolute;
            background-color: #ff0;
            border-radius: 50%;
            pointer-events: none;
            z-index: 15;
            animation: particleFade 1s ease-out forwards;
        }

        @keyframes particleFade {
            0% { opacity: 1; transform: translate(0, 0) scale(1); }
            100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0); }
        }

        .info-display {
            position: absolute;
            color: #fff;
            padding: 10px;
            font-size: 1rem;
            z-index: 20;
            text-shadow: 1px 1px 0 #000, -1px -1px 0 #000;
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
        }

        #score-display { top: 5px; left: 10px; }
        #best-score-display { top: 5px; right: 10px; }
        #lives-display { top: 30px; right: 10px; }
        #level-display { top: 5px; left: 50%; transform: translateX(-50%); }

        #base-line {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 1px;
            z-index: -1;
            background: linear-gradient(90deg, transparent, #0f0, transparent);
            box-shadow: 0 0 10px #0f0;
        }

        #game-over-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(10, 10, 10, 0.9);
            color: #f00;
            padding: 30px 50px;
            border-radius: 0;
            font-size: 2rem;
            text-align: center;
            z-index: 100;
            border: 2px solid #f00;
            display: none;
            cursor: pointer;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.5);
            animation: gameOverPulse 1.5s infinite;
        }

        @keyframes gameOverPulse {
            0%, 100% { box-shadow: 0 0 30px rgba(255, 0, 0, 0.5); }
            50% { box-shadow: 0 0 50px rgba(255, 0, 0, 0.8); }
        }

        #game-over-reason {
            display: block;
            font-size: 1rem;
            color: #ff8c00;
            margin-top: -10px;
            margin-bottom: 15px;
            text-shadow: 0 0 5px rgba(255, 140, 0, 0.7);
        }

        #game-over-message span#final-score {
            display: block;
            font-size: 1.2rem;
            margin-top: 15px;
            color: #ff0;
            text-shadow: 0 0 5px rgba(255, 255, 0, 0.7);
        }

        #game-over-message span.restart-prompt {
            font-size: 0.8rem;
            margin-top: 20px;
            display: block;
            color: #fff;
        }

        #pause-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 105;
            color: #0f0;
            font-size: 2rem;
            text-align: center;
        }

        #pause-screen button {
            margin-top: 20px;
            padding: 10px 20px;
            font-family: inherit;
            background-color: rgba(0, 0, 0, 0.5);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #pause-screen button:hover {
            background-color: #0f0;
            color: #000;
        }

        #instructions-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 110;
            color: #fff;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        #instructions-screen h2 {
            color: #ff0;
            margin-bottom: 30px;
        }

        #instructions-screen p {
            margin: 10px 0;
            max-width: 600px;
            line-height: 1.5;
        }

        #instructions-screen button {
            margin-top: 30px;
            padding: 10px 30px;
            font-family: inherit;
            background-color: rgba(0, 0, 0, 0.5);
            color: #0f0;
            border: 1px solid #0f0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        #instructions-screen button:hover {
            background-color: #0f0;
            color: #000;
        }

        /* Controlli mobili */
        #mobile-controls {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 50;
            pointer-events: none;
        }

        .mobile-btn {
            width: 80px;
            height: 80px;
            background-color: rgba(0, 255, 0, 0.3);
            border: 2px solid #0f0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
            cursor: pointer;
            pointer-events: auto;
            user-select: none;
            touch-action: manipulation;
        }

        #shoot-btn {
            position: fixed;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 100px;
            height: 100px;
            font-size: 1rem;
        }

        #pause-btn {
            position: fixed;
            left: 20px;
            top: 20px;
            width: 60px;
            height: 60px;
            font-size: 1rem;
        }

        /* Mostra i controlli solo su dispositivi mobili */
        @media (max-width: 768px), (hover: none) {
            #mobile-controls {
                display: flex;
            }
            body.game-active {
                cursor: default !important;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>

    <div id="pre-game-screen">
        <h1>INVADERS CLONE</h1>
        <label for="difficulty-select">Seleziona Difficoltà:</label>
        <select id="difficulty-select">
            <option value="FACILE">FACILE</option>
            <option value="DIFFICILE">DIFFICILE</option>
        </select>
        <button id="start-button">Inizia Gioco</button>
        <button id="instructions-button">Istruzioni</button>
    </div>

    <div id="game-container">
        <div id="sky"></div>
        <div id="score-display" class="info-display">SCORE: 0</div>
        <div id="best-score-display" class="info-display">BEST: 0</div>
        <div id="lives-display" class="info-display">LIVES: 3</div>
        <div id="level-display" class="info-display">LEVEL: 1</div>
        <div id="player-ship">
            <img src="La mia arma.png" alt="Navicella Giocatore">
        </div>
        <div id="base-line"></div>
    </div>

    <div id="game-over-message">
        GAME OVER!
        <span id="game-over-reason"></span>
        <span id="final-score"></span>
        <span class="restart-prompt">(Clicca per rigiocare)</span>
    </div>

    <div id="pause-screen">
        PAUSA
        <button id="resume-button">Riprendi</button>
        <button id="quit-button">Esci</button>
    </div>

    <div id="instructions-screen">
        <h2>ISTRUZIONI</h2>
        <p>Muovi il mouse per spostare la navicella</p>
        <p>Premi SPAZIO o Click Sinistro per sparare</p>
        <p>Evita i proiettili nemici e non far raggiungere la base agli alieni!</p>
        <p>Ogni livello completato aumenta la difficoltà</p>
        <p>Alla fine di ogni livello affronterai un boss!</p>
        <p>Premi ESC per mettere in pausa il gioco</p>
        <button id="close-instructions">Ho capito!</button>
    </div>

    <!-- Controlli mobili -->
    <div id="mobile-controls">
        <div id="left-btn" class="mobile-btn">←</div>
        <div id="right-btn" class="mobile-btn">→</div>
        <div id="shoot-btn" class="mobile-btn">SPARA</div>
        <div id="pause-btn" class="mobile-btn">II</div>
    </div>

    <script>
        // --- Riferimenti DOM ---
        const preGameScreen = document.getElementById('pre-game-screen');
        const gameContainer = document.getElementById('game-container');
        const difficultySelect = document.getElementById('difficulty-select');
        const startButton = document.getElementById('start-button');
        const instructionsButton = document.getElementById('instructions-button');
        const sky = document.getElementById('sky');
        const playerShip = document.getElementById('player-ship');
        const scoreDisplay = document.getElementById('score-display');
        const livesDisplay = document.getElementById('lives-display');
        const levelDisplay = document.getElementById('level-display');
        const gameOverMessage = document.getElementById('game-over-message');
        const gameOverReasonSpan = document.getElementById('game-over-reason');
        const finalScoreSpan = document.getElementById('final-score');
        const baseLine = document.getElementById('base-line');
        const bestScoreDisplay = document.getElementById('best-score-display');
        const pauseScreen = document.getElementById('pause-screen');
        const resumeButton = document.getElementById('resume-button');
        const quitButton = document.getElementById('quit-button');
        const instructionsScreen = document.getElementById('instructions-screen');
        const closeInstructions = document.getElementById('close-instructions');
        const bodyElement = document.body;
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');
        const shootBtn = document.getElementById('shoot-btn');
        const pauseBtn = document.getElementById('pause-btn');

        // --- Variabili Gioco ---
        let score = 0;
        let lives = 3;
        let level = 1;
        let isGameOver = false;
        let isPaused = false;
        let gameLoopId = null;
        let selectedDifficulty = 'FACILE';
        let bestScore = 0;
        const BEST_SCORE_KEY = 'invadersCloneBestScore';
        let playerX = 400;
        const playerShipWidth = 40;
        let playerShipHeight = 0;
        let playerY = 0;
        let stars = [];

        let bullets = [];
        let enemyBullets = [];
        let aliens = [];
        let alienDirection = 1;
        let alienMoveTimer = null;
        let alienShootTimer = null;
        let baseAlienMoveInterval = 1000;
        let baseAlienShootInterval = 2000;
        let currentAlienMoveInterval = 1000;
        let currentAlienShootInterval = 2000;
        const alienMoveStepX = 10;
        const alienMoveStepY = 20;
        const bulletSpeed = 7;
        const enemyBulletSpeed = 4;
        const bossBulletSpeedMultiplier = 1.5;
        let canShoot = true;
        const shootCooldown = 400;
        const alienRows = 5;
        const aliensPerRow = 10;
        const alienSpacingX = 50;
        const alienSpacingY = 40;
        const alienStartY = 50;
        const alienEmojis = ['👾', '👽', '💀', '🐙', '👻'];
        let playerInvincible = false;
        const playerInvincibilityTime = 1500;
        let baseLineY = 0;

        // --- Variabili BOSS ---
        let isBossActive = false;
        let bossData = null;
        const BOSS_MAX_HEALTH = 3;
        const BOSS_MOVE_SPEED_Y = 1;
        const BOSS_MOVE_SPEED_X = 3;
        const BOSS_SHOOT_INTERVAL = 1000;
        let bossShootTimer = null;
        const BOSS_POINTS = 500;
        const BOSS_HIT_POINTS = 20;
        let bossWidth = 100;
        let bossHeight = 0;

        // --- Variabili per i controlli mobili ---
        let leftPressed = false;
        let rightPressed = false;
        let mobileShootPressed = false;
        let mobileMoveInterval = null;
        const MOBILE_MOVE_SPEED = 5;

        // --- OGGETTI AUDIO ---
        const shootSound = new Audio('shoot.wav');
        shootSound.preload = 'auto';
        shootSound.volume = 0.7;
        const alienMoveSound = new Audio('fastinvader1.wav');
        alienMoveSound.preload = 'auto';
        alienMoveSound.loop = true;
        alienMoveSound.volume = 0.5;
        const MAX_ALIEN_SOUND_RATE = 4.0;
        const bossEntrySound = new Audio('boss_entry_sound.wav');
        bossEntrySound.preload = 'auto';
        bossEntrySound.volume = 0.7;
        const bossExplosionSound = new Audio('Esplosione_Navicella_Madre_Aliena.wav');
        bossExplosionSound.preload = 'auto';
        bossExplosionSound.volume = 0.7;
        const gameOverSound = new Audio('Game_Over_Partita_Persa.wav');
        gameOverSound.preload = 'auto';
        gameOverSound.volume = 0.7;
        const pauseSound = new Audio('data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA');
        pauseSound.volume = 0.5;

        // --- Funzioni Utilità ---
        async function playSound(sound) {
            try {
                sound.currentTime = 0;
                await sound.play();
            } catch (error) {
                console.error("Errore riproduzione audio:", error);
            }
        }

        function createStars() {
            stars.forEach(star => star.element?.remove());
            stars = [];

            const starCount = 100;
            const containerWidth = gameContainer.offsetWidth;
            const containerHeight = gameContainer.offsetHeight;

            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');

                const size = Math.random() * 2 + 1;
                const x = Math.random() * containerWidth;
                const y = Math.random() * containerHeight;
                const startOpacity = Math.random() * 0.4 + 0.1;
                const endOpacity = Math.random() * 0.5 + 0.5;
                const duration = Math.random() * 5 + 3;

                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${x}px`;
                star.style.top = `${y}px`;
                star.style.setProperty('--start-opacity', startOpacity);
                star.style.setProperty('--end-opacity', endOpacity);
                star.style.animation = `starTwinkle ${duration}s infinite alternate ease-in-out`;

                sky.appendChild(star);
                stars.push({ element: star });
            }
        }

        function createParticles(x, y, count = 10, color = '#ff0') {
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.classList.add('particle');

                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * 30 + 10;
                const size = Math.random() * 4 + 2;
                const duration = Math.random() * 0.5 + 0.5;

                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.backgroundColor = color;

                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;

                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                particle.style.animationDuration = `${duration}s`;

                sky.appendChild(particle);

                setTimeout(() => {
                    particle.remove();
                }, duration * 1000);
            }
        }

        function loadAndDisplayBestScore() {
            const storedScore = localStorage.getItem(BEST_SCORE_KEY);
            bestScore = parseInt(storedScore) || 0;
            updateBestScoreDisplay();
        }

        function updateBestScoreDisplay() {
            bestScoreDisplay.textContent = `BEST: ${bestScore}`;
        }

        function updateAlienSoundSpeed() {
            if (alienMoveSound && baseAlienMoveInterval > 0 && currentAlienMoveInterval > 0) {
                let rate = baseAlienMoveInterval / currentAlienMoveInterval;
                rate = Math.min(rate, MAX_ALIEN_SOUND_RATE);
                if (Math.abs(alienMoveSound.playbackRate - rate) > 0.05) {
                   alienMoveSound.playbackRate = rate;
                }
            }
        }

        function startAlienSound() {
            if (alienMoveSound && alienMoveSound.paused && !isBossActive && !isGameOver && !isPaused) {
                updateAlienSoundSpeed();
                playSound(alienMoveSound);
            }
        }

        function stopAlienSound() {
            if (alienMoveSound && !alienMoveSound.paused) {
                alienMoveSound.pause();
                alienMoveSound.currentTime = 0;
            }
        }

        // --- Funzioni di Gioco ---
        function movePlayer(event) {
            if (isGameOver || isPaused) return;

            const gameRect = gameContainer.getBoundingClientRect();
            let targetX = event.clientX - gameRect.left;

            const minX = playerShipWidth / 2;
            const maxX = gameRect.width - playerShipWidth / 2;

            targetX = Math.max(minX, Math.min(maxX, targetX));
            playerX = targetX;

            const visualX = playerX - playerShipWidth / 2;
            playerShip.style.transform = `translateX(${visualX}px)`;
        }

        // Funzioni per il movimento mobile
        function startMovingLeft() {
            if (isGameOver || isPaused) return;
            leftPressed = true;
            if (!mobileMoveInterval) {
                mobileMoveInterval = setInterval(mobileMovePlayer, 16);
            }
        }

        function startMovingRight() {
            if (isGameOver || isPaused) return;
            rightPressed = true;
            if (!mobileMoveInterval) {
                mobileMoveInterval = setInterval(mobileMovePlayer, 16);
            }
        }

        function stopMovingLeft() {
            leftPressed = false;
            if (!rightPressed && mobileMoveInterval) {
                clearInterval(mobileMoveInterval);
                mobileMoveInterval = null;
            }
        }

        function stopMovingRight() {
            rightPressed = false;
            if (!leftPressed && mobileMoveInterval) {
                clearInterval(mobileMoveInterval);
                mobileMoveInterval = null;
            }
        }

        function mobileMovePlayer() {
            if (isGameOver || isPaused) return;
            
            const gameRect = gameContainer.getBoundingClientRect();
            const minX = playerShipWidth / 2;
            const maxX = gameRect.width - playerShipWidth / 2;
            
            if (leftPressed) {
                playerX = Math.max(minX, playerX - MOBILE_MOVE_SPEED);
            }
            if (rightPressed) {
                playerX = Math.min(maxX, playerX + MOBILE_MOVE_SPEED);
            }
            
            const visualX = playerX - playerShipWidth / 2;
            playerShip.style.transform = `translateX(${visualX}px)`;
        }

        function mobileShoot() {
            if ((mobileShootPressed || !canShoot) || isGameOver || isPaused) return;
            mobileShootPressed = true;
            handleShoot({button: 0, preventDefault: () => {}});
            setTimeout(() => { mobileShootPressed = false; }, shootCooldown);
        }

        function createAlienFormation() {
            aliens.forEach(a => a.element?.remove());
            aliens = [];
            if (!isBossActive) {
                enemyBullets.forEach(b => b.element?.remove());
                enemyBullets = [];
            }
            const formationWidth = (aliensPerRow - 1) * alienSpacingX;
            const containerWidth = gameContainer.offsetWidth;
            const startX = (containerWidth - formationWidth) / 2;

            for (let r = 0; r < alienRows; r++) {
                for (let c = 0; c < aliensPerRow; c++) {
                    const alien = document.createElement('div');
                    alien.classList.add('alien');
                    const typeIndex = r % alienEmojis.length;
                    alien.classList.add(`alien-type-${typeIndex % 5}`);
                    alien.innerText = alienEmojis[typeIndex];
                    sky.appendChild(alien);
                    const currentAlienX = startX + c * alienSpacingX;
                    const currentAlienY = alienStartY + r * alienSpacingY;
                    alien.style.left = `${currentAlienX}px`;
                    alien.style.top = `${currentAlienY}px`;
                    const alienWidth = alien.offsetWidth;
                    const alienHeight = alien.offsetHeight;
                    const alienData = {
                        element: alien, x: currentAlienX, y: currentAlienY,
                        width: alienWidth, height: alienHeight, type: typeIndex,
                        id: `alien_${r}_${c}`, hit: false
                    };
                    alien.dataset.id = alienData.id;
                    aliens.push(alienData);
                }
            }
            alienDirection = 1;
            levelDisplay.textContent = `LEVEL: ${level}`;
        }

        function moveAliens() {
            if (isGameOver || isBossActive || isPaused) {
                clearTimeout(alienMoveTimer); return;
            }
            let moveDown = false;
            let changeDirection = false;
            const containerWidth = gameContainer.offsetWidth;
            const aliveAliens = aliens.filter(a => !a.hit && a.element);
            if (aliveAliens.length === 0) {
                clearTimeout(alienMoveTimer); return;
            }
            for (const alien of aliveAliens) {
                const nextX = alien.x + alienMoveStepX * alienDirection;
                const alienRightEdge = nextX + alien.width;
                if (nextX < 10 || alienRightEdge > containerWidth - 10) {
                    changeDirection = true; moveDown = true; break;
                }
            }
            if (changeDirection) { alienDirection *= -1; }
            for (const alien of aliveAliens) {
                if (moveDown) { alien.y += alienMoveStepY; }
                alien.x += alienMoveStepX * alienDirection;
                if (alien.element) {
                    alien.element.style.left = `${alien.x}px`;
                    alien.element.style.top = `${alien.y}px`;
                }
            }
            clearTimeout(alienMoveTimer);
            alienMoveTimer = setTimeout(moveAliens, currentAlienMoveInterval);
        }

        function alienTryShoot() {
            if (isGameOver || isBossActive || isPaused) {
                clearTimeout(alienShootTimer); return;
            }
            const aliveAliens = aliens.filter(a => !a.hit && a.element);
            if (aliveAliens.length === 0) return;
            const columns = {};
            aliveAliens.forEach(a => {
                const colKey = Math.floor(a.x / alienSpacingX);
                if (!columns[colKey]) { columns[colKey] = []; }
                columns[colKey].push(a);
            });
            const shooters = [];
            for (const key in columns) {
                let bottomAlien = columns[key][0];
                for (let i = 1; i < columns[key].length; i++) {
                    if (columns[key][i].y > bottomAlien.y) { bottomAlien = columns[key][i]; }
                }
                shooters.push(bottomAlien);
            }
            if (shooters.length > 0) {
                const randomShooter = shooters[Math.floor(Math.random() * shooters.length)];
                const bullet = document.createElement('div');
                bullet.classList.add('enemy-bullet');
                const bulletX = randomShooter.x + randomShooter.width / 2 - 2;
                const bulletY = randomShooter.y + randomShooter.height;
                bullet.style.left = `${bulletX}px`; bullet.style.top = `${bulletY}px`;
                sky.appendChild(bullet);
                const bulletWidth = bullet.offsetWidth || 4;
                const bulletHeight = bullet.offsetHeight || 10;
                const bulletData = { element: bullet, x: bulletX, y: bulletY, width: bulletWidth, height: bulletHeight, id: Date.now() + '_enemy' };
                enemyBullets.push(bulletData);
            }
            clearTimeout(alienShootTimer);
            alienShootTimer = setTimeout(alienTryShoot, currentAlienShootInterval);
        }

        function handleShoot(event) {
            if ((event.code === 'Space' || event.button === 0) && !isGameOver && canShoot && !isPaused) {
                event.preventDefault(); canShoot = false;
                setTimeout(() => { canShoot = true; }, shootCooldown);
                const bullet = document.createElement('div'); bullet.classList.add('bullet');
                const bulletX = playerX - 2; const bulletY = playerY - 10;
                bullet.style.left = `${bulletX}px`; bullet.style.top = `${bulletY}px`;
                sky.appendChild(bullet);
                const bulletWidth = bullet.offsetWidth || 4; const bulletHeight = bullet.offsetHeight || 10;
                const bulletData = { element: bullet, x: bulletX, y: bulletY, width: bulletWidth, height: bulletHeight, id: Date.now() + '_player' };
                bullets.push(bulletData); playSound(shootSound);
            }
        }

        function createExplosion(x, y, size = 1.8, color = '#ffa500') {
            const explosion = document.createElement('div');
            explosion.classList.add('explosion'); explosion.innerText = '💥';
            explosion.style.left = `${x}px`; explosion.style.top = `${y}px`;
            explosion.style.fontSize = `${size}rem`; explosion.style.color = color;
            sky.appendChild(explosion);
            setTimeout(() => { explosion.remove(); }, 300);
            createParticles(x, y, 15, color);
        }

        function checkAABBCollision(x1, y1, width1, height1, x2, y2, width2, height2) {
            return (x1 < x2 + width2 && x1 + width1 > x2 && y1 < y2 + height2 && y1 + height1 > y2);
        }
        function updateScoreDisplay() { scoreDisplay.textContent = `SCORE: ${score}`; }
        function updateLivesDisplay() { livesDisplay.textContent = `LIVES: ${lives}`; }

        function playerHit() {
            if (playerInvincible || isGameOver || isPaused) return;
            lives--; updateLivesDisplay(); playerInvincible = true;
            playerShip.classList.add('hit');
            const explosionX = playerX; const explosionY = playerY + playerShipHeight / 2;
            createExplosion(explosionX, explosionY, 2, '#f00');
            if (lives <= 0) {
                playerShip.style.opacity = '0'; triggerGameOver("Hai finito le vite!");
            } else {
                setTimeout(() => { playerInvincible = false; playerShip.classList.remove('hit'); }, playerInvincibilityTime);
            }
        }

        function triggerGameOver(reason = "Game Over!") {
            if (isGameOver) return; isGameOver = true;
            stopAlienSound(); playSound(gameOverSound);
            if (score > bestScore) {
                bestScore = score; localStorage.setItem(BEST_SCORE_KEY, bestScore.toString()); updateBestScoreDisplay();
            }
            clearTimeout(alienMoveTimer); clearTimeout(alienShootTimer); clearTimeout(bossShootTimer);
            if (gameLoopId) { cancelAnimationFrame(gameLoopId); gameLoopId = null; }
            gameOverReasonSpan.textContent = reason; finalScoreSpan.textContent = `Punteggio Finale: ${score}`;
            gameOverMessage.style.display = 'block';
            bodyElement.style.cursor = 'default'; bodyElement.classList.remove('game-active');
        }

        // --- Funzioni BOSS ---
        function spawnBoss() {
            isBossActive = true;
            clearTimeout(alienMoveTimer); clearTimeout(alienShootTimer); stopAlienSound();
            const bossElement = document.createElement('div'); bossElement.id = 'boss-ship';
            const bossImg = document.createElement('img'); bossImg.src = 'Navicella madre aliena.png'; bossImg.alt = 'Boss Alieno';
            bossElement.appendChild(bossImg); sky.appendChild(bossElement);
            bossWidth = bossElement.offsetWidth; bossHeight = bossElement.offsetHeight;
            bossData = {
                element: bossElement, health: BOSS_MAX_HEALTH * level, x: gameContainer.offsetWidth / 2 - bossWidth / 2,
                y: -bossHeight, width: bossWidth, height: bossHeight, directionX: (Math.random() < 0.5) ? 1 : -1, shootCooldown: false
            };
            bossElement.style.transform = `translate(${bossData.x}px, ${bossData.y}px)`;
            playSound(bossEntrySound);
            clearTimeout(bossShootTimer); bossShootTimer = setTimeout(bossTryShoot, BOSS_SHOOT_INTERVAL * 1.5);
        }

        function bossTryShoot() {
            if (!isBossActive || isGameOver || !bossData || bossData.health <= 0 || !bossData.element || isPaused) {
                clearTimeout(bossShootTimer); return;
            }
            const bullet = document.createElement('div'); bullet.classList.add('boss-bullet');
            const bulletX = bossData.x + bossData.width / 2 - 3; const bulletY = bossData.y + bossData.height;
            bullet.style.left = `${bulletX}px`; bullet.style.top = `${bulletY}px`;
            sky.appendChild(bullet);
            const bulletWidth = bullet.offsetWidth || 6; const bulletHeight = bullet.offsetHeight || 12;
            const bulletData = { element: bullet, x: bulletX, y: bulletY, width: bulletWidth, height: bulletHeight, id: Date.now() + '_boss' };
            enemyBullets.push(bulletData);
            clearTimeout(bossShootTimer);
            const baseInterval = BOSS_SHOOT_INTERVAL / Math.sqrt(level); const randomDelay = (Math.random() - 0.5) * 400;
            const nextShootDelay = Math.max(300, baseInterval + randomDelay);
            bossShootTimer = setTimeout(bossTryShoot, nextShootDelay);
        }

        function bossHit() {
            if (!isBossActive || !bossData || bossData.health <= 0 || isPaused || isGameOver) return;
            bossData.health--; score += BOSS_HIT_POINTS * level; updateScoreDisplay();
            if(bossData.element) {
                bossData.element.classList.add('hit-visual');
                setTimeout(() => { bossData.element?.classList.remove('hit-visual'); }, 100);
                const explosionX = bossData.x + Math.random() * bossData.width; const explosionY = bossData.y + Math.random() * bossData.height;
                createExplosion(explosionX, explosionY, 1.5, '#ff8c00');
            }
            if (bossData.health <= 0) { bossDefeated(); }
        }

        function bossDefeated() {
            clearTimeout(bossShootTimer);
            score += BOSS_POINTS * level;
            updateScoreDisplay();
            playSound(bossExplosionSound);

            if (bossData && bossData.element) {
                const centerX = bossData.x + bossData.width / 2;
                const centerY = bossData.y + bossData.height / 2;
                for (let i = 0; i < 15; i++) {
                    setTimeout(() => {
                        const offsetX = (Math.random() - 0.5) * bossData.width * 0.8;
                        const offsetY = (Math.random() - 0.5) * bossData.height * 0.8;
                        createExplosion(centerX + offsetX, centerY + offsetY, 2, i % 2 ? '#ff0' : '#f80');
                    }, i * 50);
                }
                bossData.element.style.transition = 'opacity 0.5s linear';
                bossData.element.style.opacity = '0';
                const elementToRemove = bossData.element;
                setTimeout(() => {
                    elementToRemove?.remove();
                }, 500);
            }

            setTimeout(() => {
                isBossActive = false;
                bossData = null;
            }, 550);
        }

        function advanceLevel() {
            isBossActive = false;
            level++;
            lives = 3;
            updateLivesDisplay();

            const existingBoss = document.getElementById('boss-ship');
            if (existingBoss) { existingBoss.remove(); }
            bossData = null;
            clearTimeout(bossShootTimer);

            const difficultyFactor = 1 + (level - 1) * (selectedDifficulty === 'DIFFICILE' ? 0.2 : 0.1);
            currentAlienMoveInterval = Math.max(150, baseAlienMoveInterval / difficultyFactor);
            currentAlienShootInterval = Math.max(500, baseAlienShootInterval / difficultyFactor);

            bullets.forEach(b => b.element?.remove()); bullets = [];
            enemyBullets.forEach(b => b.element?.remove()); enemyBullets = [];

            createAlienFormation();

            clearTimeout(alienMoveTimer); clearTimeout(alienShootTimer);
            alienMoveTimer = setTimeout(moveAliens, currentAlienMoveInterval);
            alienShootTimer = setTimeout(alienTryShoot, currentAlienShootInterval);

            levelDisplay.textContent = `LEVEL: ${level}`;
            startAlienSound();
        }

        // --- Pausa del Gioco ---
        function togglePause() {
            if (isGameOver) return;
            isPaused = !isPaused;
            if (isPaused) {
                pauseScreen.style.display = 'flex'; stopAlienSound(); playSound(pauseSound);
                bodyElement.style.cursor = 'default';
                if (gameLoopId) { cancelAnimationFrame(gameLoopId); gameLoopId = null; }
                 clearTimeout(alienMoveTimer); clearTimeout(alienShootTimer); clearTimeout(bossShootTimer);
            } else {
                pauseScreen.style.display = 'none'; bodyElement.style.cursor = 'none';
                startAlienSound();
                if (!isBossActive) {
                     alienMoveTimer = setTimeout(moveAliens, currentAlienMoveInterval);
                     alienShootTimer = setTimeout(alienTryShoot, currentAlienShootInterval);
                } else if (bossData && bossData.health > 0) {
                     bossShootTimer = setTimeout(bossTryShoot, BOSS_SHOOT_INTERVAL);
                }
                if (!gameLoopId) { gameLoopId = requestAnimationFrame(gameLoop); }
            }
        }

        // --- Game Loop Principale ---
        function gameLoop() {
            if (isGameOver || isPaused) {
                 if (gameLoopId) cancelAnimationFrame(gameLoopId); gameLoopId = null; return;
            }
            const skyRect = sky.getBoundingClientRect();
            const playerShipRect = playerShip.getBoundingClientRect();
            playerY = playerShipRect.top - skyRect.top; playerShipHeight = playerShipRect.height;
            const baseLineRect = baseLine.getBoundingClientRect(); baseLineY = baseLineRect.top - skyRect.top;

            if (isBossActive) {
                if (!bossData) {
                     advanceLevel();
                     requestAnimationFrame(gameLoop);
                     return;
                }
                else if (bossData.health <= 0) {
                }
                else {
                    bossData.y += BOSS_MOVE_SPEED_Y; bossData.x += BOSS_MOVE_SPEED_X * bossData.directionX;
                    const containerWidth = gameContainer.offsetWidth;
                    if (bossData.x + bossData.width > containerWidth - 10) { bossData.x = containerWidth - 10 - bossData.width; bossData.directionX = -1; }
                    else if (bossData.x < 10) { bossData.x = 10; bossData.directionX = 1; }
                    if(bossData.element) { bossData.element.style.transform = `translate(${bossData.x}px, ${bossData.y}px)`; }
                    if (bossData.y + bossData.height >= baseLineY) { triggerGameOver("Il Boss ha raggiunto la base!"); return; }
                    if (!playerInvincible && checkAABBCollision( bossData.x, bossData.y, bossData.width, bossData.height, playerX - playerShipWidth/2, playerY, playerShipWidth, playerShipHeight )) { playerHit(); if (isGameOver) return; }
                    for (let i = bullets.length - 1; i >= 0; i--) {
                        const bullet = bullets[i]; bullet.y -= bulletSpeed;
                        if (bullet.element) bullet.element.style.top = `${bullet.y}px`;
                        if (bullet.y + bullet.height < 0) { bullet.element?.remove(); bullets.splice(i, 1); continue; }
                        if (bossData && bossData.health > 0) {
                            if (checkAABBCollision( bullet.x, bullet.y, bullet.width, bullet.height, bossData.x, bossData.y, bossData.width, bossData.height )) {
                                bullet.element?.remove(); bullets.splice(i, 1); bossHit();
                            }
                        }
                    }
                }
            } else {
                 for (let i = bullets.length - 1; i >= 0; i--) {
                    const bullet = bullets[i]; bullet.y -= bulletSpeed;
                    if (bullet.element) bullet.element.style.top = `${bullet.y}px`;
                    if (bullet.y + bullet.height < 0) { bullet.element?.remove(); bullets.splice(i, 1); continue; }
                    let bulletHitAlien = false;
                    for (let j = aliens.length - 1; j >= 0; j--) {
                        const alien = aliens[j];
                        if (alien.hit || !alien.element || !alien.element.parentNode) continue;
                        if (checkAABBCollision( bullet.x, bullet.y, bullet.width, bullet.height, alien.x, alien.y, alien.width, alien.height )) {
                            score += 10 * level; updateScoreDisplay();
                            const explosionX = alien.x + alien.width / 2; const explosionY = alien.y + alien.height / 2;
                            createExplosion(explosionX, explosionY);
                            alien.hit = true; if (alien.element) alien.element.style.opacity = '0';
                            bullet.element?.remove(); bullets.splice(i, 1); bulletHitAlien = true;
                            const elementToRemove = alien.element; setTimeout(() => { elementToRemove?.remove(); }, 150);
                            let aliveAliensCount = aliens.filter(a => !a.hit).length; let totalAliens = alienRows * aliensPerRow;
                            let speedMultiplier = 1 + ((totalAliens - aliveAliensCount) / totalAliens) * 1.5;
                            const levelBaseInterval = baseAlienMoveInterval / (1 + (level - 1) * (selectedDifficulty === 'DIFFICILE' ? 0.2 : 0.1));
                            currentAlienMoveInterval = Math.max(80, levelBaseInterval / speedMultiplier);
                            updateAlienSoundSpeed(); clearTimeout(alienMoveTimer);
                            alienMoveTimer = setTimeout(moveAliens, currentAlienMoveInterval);
                            break;
                        }
                    }
                    if (bulletHitAlien) continue;
                }

                const aliveAliens = aliens.filter(a => !a.hit);
                if (aliveAliens.length === 0 && aliens.length > 0 && !isBossActive) {
                    aliens.forEach(a => a.element?.remove()); aliens = []; spawnBoss();
                 } else if (aliens.length === 0 && !isBossActive && !isGameOver) {
                 }

                let alienReachedBase = false;
                for (const alien of aliveAliens) {
                    if (!alien.element || !alien.element.parentNode) continue;
                    if (alien.y + alien.height >= baseLineY) { alienReachedBase = true; break; }
                    if (!playerInvincible && checkAABBCollision( alien.x, alien.y, alien.width, alien.height, playerX - playerShipWidth/2, playerY, playerShipWidth, playerShipHeight )) { playerHit(); if (isGameOver) return; }
                }
                if (alienReachedBase) { triggerGameOver("Gli alieni hanno raggiunto la base!"); return; }
            }

            for (let i = enemyBullets.length - 1; i >= 0; i--) {
                const bullet = enemyBullets[i];
                const speed = bullet.element?.classList.contains('boss-bullet') ? enemyBulletSpeed * bossBulletSpeedMultiplier : enemyBulletSpeed;
                bullet.y += speed; if (bullet.element) bullet.element.style.top = `${bullet.y}px`;
                const containerHeight = sky.offsetHeight;
                if (bullet.y > containerHeight) { bullet.element?.remove(); enemyBullets.splice(i, 1); continue; }
                if (!playerInvincible) {
                    if (checkAABBCollision( bullet.x, bullet.y, bullet.width, bullet.height, playerX - playerShipWidth/2, playerY, playerShipWidth, playerShipHeight )) {
                        bullet.element?.remove(); enemyBullets.splice(i, 1); playerHit(); if(isGameOver) return;
                    }
                }
            }

            if (!isGameOver && !isPaused) {
                 gameLoopId = requestAnimationFrame(gameLoop);
            } else {
                 gameLoopId = null;
            }
        }

        function initializeGame(difficulty) {
            selectedDifficulty = difficulty; score = 0; lives = 3; level = 1;
            isGameOver = false; isPaused = false; bullets = []; enemyBullets = []; aliens = []; isBossActive = false;
            sky.innerHTML = ''; createStars();
            const existingBoss = document.getElementById('boss-ship'); if (existingBoss) { existingBoss.remove(); }
            bossData = null; clearTimeout(bossShootTimer);
            playerShip.style.opacity = '1'; playerShip.classList.remove('hit'); playerInvincible = false;
            playerShipHeight = playerShip.offsetHeight;
            const skyRect = gameContainer.getBoundingClientRect();
            const playerShipRect = playerShip.getBoundingClientRect(); playerY = playerShipRect.top - skyRect.top;
            const baseLineRect = baseLine.getBoundingClientRect(); baseLineY = baseLineRect.top - skyRect.top;
            playerX = gameContainer.offsetWidth / 2;
            const initialVisualX = playerX - playerShipWidth / 2; playerShip.style.transform = `translateX(${initialVisualX}px)`;
            baseAlienMoveInterval = (difficulty === 'DIFFICILE') ? 750 : 1000;
            baseAlienShootInterval = (difficulty === 'DIFFICILE') ? 1500 : 2000;
            currentAlienMoveInterval = baseAlienMoveInterval; currentAlienShootInterval = baseAlienShootInterval;
            updateScoreDisplay(); updateLivesDisplay(); levelDisplay.textContent = `LEVEL: ${level}`; updateBestScoreDisplay();
            gameOverMessage.style.display = 'none'; pauseScreen.style.display = 'none';
            document.removeEventListener('mousemove', movePlayer); document.removeEventListener('keydown', handleShoot); document.removeEventListener('click', handleShoot);
            document.addEventListener('mousemove', movePlayer); document.addEventListener('keydown', handleShoot); document.addEventListener('click', handleShoot);
            if (alienMoveTimer) clearTimeout(alienMoveTimer); if (alienShootTimer) clearTimeout(alienShootTimer); if (gameLoopId) cancelAnimationFrame(gameLoopId); gameLoopId = null;
            createAlienFormation();
            alienMoveTimer = setTimeout(moveAliens, currentAlienMoveInterval); alienShootTimer = setTimeout(alienTryShoot, currentAlienShootInterval);
            startAlienSound(); gameLoopId = requestAnimationFrame(gameLoop);

            // Disabilita lo zoom e lo scroll su mobile
            document.addEventListener('touchmove', (e) => {
                if (bodyElement.classList.contains('game-active')) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        // --- Event Listener Iniziali ---
        startButton.addEventListener('click', () => {
            const chosenDifficulty = difficultySelect.value; preGameScreen.style.display = 'none'; gameContainer.style.display = 'block';
            bodyElement.style.cursor = 'none'; bodyElement.classList.add('game-active');
            requestAnimationFrame(() => { initializeGame(chosenDifficulty); });
        });
        instructionsButton.addEventListener('click', () => { instructionsScreen.style.display = 'flex'; });
        closeInstructions.addEventListener('click', () => { instructionsScreen.style.display = 'none'; });
        gameOverMessage.addEventListener('click', () => {
            gameOverMessage.style.display = 'none'; gameContainer.style.display = 'none'; preGameScreen.style.display = 'flex';
            bodyElement.style.cursor = 'default'; bodyElement.classList.remove('game-active'); stopAlienSound();
        });
        resumeButton.addEventListener('click', togglePause);
        quitButton.addEventListener('click', () => {
            if (isPaused) togglePause(); isGameOver = true; gameContainer.style.display = 'none'; preGameScreen.style.display = 'flex';
            bodyElement.style.cursor = 'default'; bodyElement.classList.remove('game-active'); stopAlienSound();
            clearTimeout(alienMoveTimer); clearTimeout(alienShootTimer); clearTimeout(bossShootTimer); if (gameLoopId) cancelAnimationFrame(gameLoopId); gameLoopId = null;
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && bodyElement.classList.contains('game-active') && !isGameOver) { togglePause(); }
        });

        // Event listener per i controlli mobili
        leftBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startMovingLeft();
        });
        leftBtn.addEventListener('touchend', stopMovingLeft);
        leftBtn.addEventListener('touchcancel', stopMovingLeft);

        rightBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startMovingRight();
        });
        rightBtn.addEventListener('touchend', stopMovingRight);
        rightBtn.addEventListener('touchcancel', stopMovingRight);

        shootBtn.addEventListener('touchstart', (e) => {
            e.preventDefault();
            mobileShoot();
        });

        pauseBtn.addEventListener('click', togglePause);

        // Supporto anche per click (per dispositivi ibridi)
        leftBtn.addEventListener('mousedown', startMovingLeft);
        leftBtn.addEventListener('mouseup', stopMovingLeft);
        leftBtn.addEventListener('mouseleave', stopMovingLeft);

        rightBtn.addEventListener('mousedown', startMovingRight);
        rightBtn.addEventListener('mouseup', stopMovingRight);
        rightBtn.addEventListener('mouseleave', stopMovingRight);

        shootBtn.addEventListener('click', mobileShoot);

        // --- Initialization on Page Load ---
        loadAndDisplayBestScore(); bodyElement.style.cursor = 'default';
    </script>
</body>
</html>